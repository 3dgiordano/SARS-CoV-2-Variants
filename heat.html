<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>COVID-19 Risk by @3dgiordano</title>
  <meta name="generator" content="Jekyll v3.9.0" />
  <meta property="og:title" content="COVID-19-Risk" />
  <meta name="author" content="David Giordano" />
  <meta property="og:locale" content="en_US" />
  <meta name="description" content="COVID-19 Risk by @3dgiordano" />
  <meta property="og:description" content="COVID-19 Risk by @3dgiordano" />
  <link rel="canonical" href="https://3dgiordano.github.io/COVID-19-Risk/" />
  <meta property="og:url" content="https://3dgiordano.github.io/COVID-19-Risk/" />
  <meta property="og:site_name" content="COVID-19 Risk by @3dgiordano" />
  <meta name="twitter:card" content="summary" />
  <meta property="twitter:title" content="COVID-19 Risk by @3dgiordano" />
  <meta property="og:image" content="/web/favicon.png">
  <link rel="shortcut icon" type="image/x-icon" href="./web/favicon.ico">
  <link rel="shortcut icon" type="image/png" href="./web/favicon.png">
  <link rel="apple-touch-icon" sizes="170x170" href="./web/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./web/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./web/favicon-16x16.png">
  <link rel='stylesheet' href='web/general.css'>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QBJJX8MJH3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-QBJJX8MJH3');
  </script>
  <script type="application/ld+json">
{"headline":"COVID-19 Risk by @3dgiordano","description":"COVID-19 Risk by @3dgiordano","url":"https://3dgiordano.github.io/COVID-19-Risk/","@type":"WebSite","name":"COVID-19 Risk by @3dgiordano","author":{"@type":"Person","name":"David Giordano"},"@context":"https://schema.org"}
</script>
  <style>

    @media screen and (max-width: 1024px) {
      table {
        width: 100%;
      }

      tbody td {
        display: block;
        width: 100% !important;
      }

      tbody td:before {
        content: attr(data-th);
        display: block;
        width: 100% !important;

      }
    }
  </style>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.27.3/apexcharts.min.js'></script>
  <script src='https://gmousse.github.io/dataframe-js/dist/dataframe.min.js'></script>

  <script id="rendered-js" crossorigin="anonymous">
    var doc_width = 1024;
    var chart_width = 640;
    var chart_list = [];
    var continents_chart;
    var df_dates = [];
    var df_cases = null;

    function windowSizeUpdate() {
      doc_width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
      chart_width = parseInt((doc_width / 2) - 70);
      if (doc_width <= 1024) {
        chart_width = parseInt(doc_width - 100);
      }
      
      chart_list.forEach(chart => {
        ApexCharts.exec(chart, 'updateOptions', {
          chart: {
            width: chart_width + "px"
          }
        });
      });
    
    }

    //window.addEventListener('resize', windowSizeUpdate);
    //windowSizeUpdate();


    function start() {

      dfjs.DataFrame.fromJSON("https://3dgiordano.github.io/SARS-CoV-2-Variants/data/update.json").then(df => {
        var update_date_str = df.select("last_update_utc").toArray().join('') + "Z";
        var date_str = new Date(update_date_str).toString();
        document.getElementById("last_update").innerText = date_str;
      });

      load_chart();
      update_continent();

    }

    function load_chart() {
      df_dates = [];
      series = [];
      ranges = [
                  {
                    from: 0,
                    to: 0.0999999999,
                    name: 'low [0 to 0.09]',
                    color: '#A0CE9D'
                  },
                  {
                    from: 0.1,
                    to: 0.9999999999,
                    name: 'warning [0.1 to 0.99]',
                    color: '#F9E7AF'
                  },
                  {
                    from: 1,
                    to: 1.4999999999,
                    name: 'caution [1 to 1.49]',
                    color: '#F9A74F'
                  },
                  {
                    from: 1.5,
                    to: 1.9999999999,
                    name: 'to risky wave [1.5 to 1.99]',
                    color: '#CAA84B'
                  },
                  {
                    from: 2,
                    to: 3.9999999999,
                    name: 'high wave [2 to 3.99]',
                    color: '#F5181B'
                  },
                  {
                    from: 4,
                    to: 5.9999999999,
                    name: 'very high wave [4 to 5.99]',
                    color: '#FC28A0'
                  },
                  {
                    from: 6,
                    to: 12,
                    name: 'critical wave [more than 6]',
                    color: '#0B090A'
                  },
                ];

      var options = {
            series: series,
            noData: {
              text: "Loading...",
            },
            chart: {
              height: 250,
              type: 'heatmap',
              redrawOnParentResize: false,
              redrawOnWindowResize: true,
              animations: { enabled: false },
              stroke: {
                width: 1
              },
              toolbar: {
                show: false,
              },
              zoom: {
                enabled: false,
              },
            },
          legend: {
              offsetY: -5,
              onItemClick: {
                toggleDataSeries: false
              },
              onItemHover: {
                  highlightDataSeries: false
              },
          }, 
          xaxis:{
            show: true,
            type: 'datetime',
            categories: df_dates,
            position: "top",
            axisBorder: {
              show: true,
              color: '#78909C',
              offsetX: 0,
              offsetY: 00
            },
            axisTicks: {
              show: true,
              borderType: 'solid',
              color: '#78909C',
              width: 6,
              offsetX: 0,
              offsetY: 00
            },
            tooltip: {
              enabled: false
            },
            labels:{
              show:true,
              offsetY: -5,
              rotate: 0,
              trim: false,
              style: {
                fontSize: 9,
              }
            },
          },
          yaxis:{
            show: true,
            showAlways: true,
            opposite: true,
            reversed: true,
            floating: false,
            labels:{
              show:true,
              align:"left",
              offsetY: 0,
              rotate: 0,
              trim: true,
              maxWidth: 100,
            },
            axisBorder: {
              show: true,
              color: '#78909C',
              offsetX: 0,
              offsetY: 00
            },
            axisTicks: {
              show: true,
              borderType: 'solid',
              color: '#78909C',
              width: 6,
              offsetX: 0,
              offsetY: 16
            },
              
          },
          plotOptions: {
            heatmap: {
              shadeIntensity: 0.5,
              radius: 0,
              useFillColorAsStroke: true,
              colorScale: {
                ranges: ranges
              },
            },
          },
          dataLabels: {
            enabled: true,
            formatter: function(value, { seriesIndex, dataPointIndex, w }) {
              return w.config.series[seriesIndex].data[dataPointIndex]["variation"]
            }
          },
          tooltip: {
            x: {
              show: true,
              formatter: function(value) {
                v_date = new Date(value);
                f_date = new Date(v_date - (( 3600 * 1000 * 24) * 13 )); 
                return  f_date.toISOString().split("T")[0] + " to " + v_date.toISOString().split("T")[0];
              },
            },
            y: {
              formatter: function (value, { series, seriesIndex, dataPointIndex, w }) {
                item_value = Number(series[seriesIndex][dataPointIndex]);
                found = "Not found";
                ranges.map((range, index) => {
                  if (item_value >= range.from && item_value <= range.to) {
                    found = item_value + " = " + range.name;
                  }
                })
                return found;
              }
            }
              
          },
          title: {
            text: "",
            align: 'center',
            margi: 0,
            offsetY: -5,
            style: {
              fontSize: '16px',
              fontFamily: "Verdana"
            },
          },
        };
      
      continents_chart = new ApexCharts(document.querySelector("#continent" ), options);
      continents_chart.render();
      
    }

    function update_continent() {
      document.getElementById("loading").style.visibility = "visible";
      document.getElementById("continent").style.visibility = "hidden";

      continent = document.querySelector('input[name="continent"]:checked').id.replace("_", " ");

      new Promise(() => {
          
          dfjs.DataFrame.fromCSV('https://3dgiordano.github.io/SARS-CoV-2-Variants/data/cases_r.csv').then(df => {
  
            if (df_dates.length == 0) {
              df_dates = [...new Set(df.sortBy('date').toArray("date"))];
            }
            if (df_cases == null) {
              df_cases = df.groupBy('continent','location').aggregate(group => group.stat.sum('cases')).rename('aggregation', 'cases');
              df_cases = df_cases.sortBy('continent', "location");
            }
            var i = 0;
            var row;
  
            new Promise(() => {

              // console.log(continent);
              series = [];

              locations = [...new Set(df.filter(row => row.get('continent') == continent).toArray("location"))];

              continent_height = locations.length * 33;
              // console.log("    " + continent_height);

              locations.forEach(location => {
                // console.log("    " + location);
                tot_cases = df_cases.filter(row => row.get('location') == location && row.get('continent') == continent).toArray("cases");
                // console.log("      " + tot_cases);
                
                if (tot_cases > 50) {

                  df_cases_risk = df.filter(row => row.get('location') == location).toArray("risk3");
                  df_cases_dates = df.filter(row => row.get('location') == location).toArray("date");
                  df_cases_variations = df.filter(row => row.get('location') == location).toArray("variation");
                  df_cases_var_incs = df.filter(row => row.get('location') == location).toArray("var_inc");
                  df_cases_var_inc_fmt = df.filter(row => row.get('location') == location).toArray("var_inc_fmt");
                  
                  data = []
                  d = 0;
                  df_dates.forEach(df_date => {
                    
                    dci = df_cases_dates.indexOf(df_date);
                    
                    dcv = 0;
                    variation = "";
                    if (dci > -1) {
                      dcv = parseFloat(df_cases_risk[dci].toString().replace(',', '.')).toFixed(2);
                      variation = df_cases_var_inc_fmt[dci];
                      
                    }
                    data.push(
                      { x: df_date, y: dcv, variation: variation}
                    );
                    d +=1
                  });

                  series.push(
                      { name: location, data: data }
                    );

                  i += 1;
                }
                
              });
              
              continents_chart.updateOptions(
                {
                  chart: {
                    height: continent_height,
                  },
                  title: {text:continent},
                  series: series,
                  noData: {
                    text: "No Data",
                  },
                }, 
                true, false, true
              );
              document.getElementById("loading").style.visibility = "hidden";
              document.getElementById("continent").style.visibility = "visible";
            });
          });
        });
      
    }
  </script>

<div style="margin: 20px;">
  <h1>COVID-19 Risk</h1>
  <div style="margin: 20px;">
    This site tries to give a glimpse about a possible wave of cases.<br />
    <br />
    <b>Last update: </b><span id="last_update"></span><br>
    <br /><br />
    <table><tr><td><a class="button" href="./map">World Map</a></td><td><a class="button" href="trend">Trends</a></td><td><a class="button_active" href="heat">Heat Map</a></td><td><a class="button" href="scatter">Scatter</a></td><td><a class="button" href="about_r">About</a></td></tr></table><table></table><br>
    <br />
    <form style="text-align: center">
      <label style="white-space:nowrap"><input type="radio" name="continent" id="Europe" checked onclick="update_continent();"/>Europe</label>
      <label style="white-space:nowrap"><input type="radio" name="continent" id="North_America" onclick="update_continent();"/>North America</label>
      <label style="white-space:nowrap"><input type="radio" name="continent" id="South_America" onclick="update_continent();"/>South America</label>
      <label style="white-space:nowrap"><input type="radio" name="continent" id="Asia" onclick="update_continent();"/>Asia</label>
      <label style="white-space:nowrap"><input type="radio" name="continent" id="Africa" onclick="update_continent();"/>Africa</label>
      <label style="white-space:nowrap"><input type="radio" name="continent" id="Oceania" onclick="update_continent();"/>Oceania</label>
    </form>
  </div>
</div>

  <table id="content" style="width: 100%;border-spacing:30px 10px;">
    <tr>
      <td colspan=2 align="center">
        <span id="loading">Loading...</span>
        <div style="visibility: hidden" id="continent"></div>
      </td>
    </tr>
  </table>
  <script>
    start();
  </script>
  </body>

</html>